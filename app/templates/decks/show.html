{% extends "base.html" %}

{% block head %}
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/deckpage.css') }}">
    {% if csrf_token %}
      <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}

</head>
{% endblock %}

{% block content %}
<main class="deck-container">

    <h1>{{ deckname }}</h1>
    <!-- Non-intrusive controls above the header content -->
    <div class="deck-header-controls">
        <button type="button" id="btn-mode-stats" class="btn small primary">Stats</button>
        <button type="button" id="btn-mode-achievements" class="btn small">Achievements</button>
    </div>

    <section class="deck-header">
        <div>
            {% if is_owner %}
                <a href="{{ url_for('decks.choose_commander_image', deckname=deckname) }}">
                    <img src="{{ commander }}" alt="Commander Image" class="commander-image" title="Bild ändern">
                </a>
            {% else %}
                <img src="{{ commander }}" alt="Commander Image" class="commander-image">
            {% endif %}
        </div>
        <div class="deck-header-text">
            <div class="deck-stats-summary">
                <p><strong>Gespielte Spiele:</strong> {{ deck_stats.games }}</p>
                <p><strong>Avg Podsize:</strong> {{ deck_stats.avg_participants }}</p>
                <p><strong>Siege:</strong> {{ deck_stats.wins }}</p>
                <p><strong>Winrate:</strong> {{ deck_stats.winrate }}%</p>
                <p><strong>Zuletzt gespielt:</strong> {{ deck_stats.last_played }}</p>
                <p><strong>Average Winning Turn:</strong> {{ deck_stats.avg_turns }}</p>
                <p><strong>Median Winning Turn:</strong> {{ deck_stats.median_turns }}</p>
                <p><strong>Winning Turn Range:</strong> {{ deck_stats.min_turns }} – {{ deck_stats.max_turns }}</p>
            </div>
        </div>
            <div class="deck-stats-breakdown">
                {% for size in [3, 4, 5] %}
                    <div class="stat-group">
                        <h4>{{ size }} Spieler:</h4>
                        <p><strong>Spiele:</strong> {{ deck_stats_by_size[size].games }}</p>
                        <p><strong>Siege:</strong> {{ deck_stats_by_size[size].wins }}</p>
                        <p><strong>Winrate:</strong> {{ deck_stats_by_size[size].winrate }}%</p>
                        <p><strong>Avg Win Turns:</strong> {{ deck_stats_by_size[size].avg_turns }}</p>
                        <p><strong>Median Win Turns:</strong> {{ deck_stats_by_size[size].median_turns }}</p>
                    </div>
                {% endfor %}
            </div>

        <!-- Achievements mode content (hidden by default). Spans the two right columns. -->
        <div id="deck-header-achievements" class="deck-header-achievements" style="display:none;">
            {% if achievements|length > 0 %}
                <div class="achievements-grid" id="achievements-grid">
                    {% for a in achievements %}
                        <div class="achievement-card" data-achievement-id="{{ a.id }}">
                            <div class="achievement-header" style="display:flex; align-items:center; justify-content:space-between;">
                                <h4 class="achievement-title" style="margin:0;">{{ a.titel }}</h4>
                                {% if is_owner %}
                                <button type="button" class="btn small btn-ach-delete" title="Achievement löschen" aria-label="Achievement löschen">✕</button>
                                {% endif %}
                            </div>

                            <p class="achievement-desc">{{ a.beschreibung }}</p>
                            <div class="achievement-checks">
                                {% set total = a.anzahl or 0 %}
                                {% set done = a.achieved or 0 %}
                                {% for i in range(total) %}
                                    <label class="check" title="{{ i < done and 'erreicht' or 'offen' }}">
                                        <input type="checkbox" class="achievement-check"
                                               {% if i < done %}checked{% endif %}>
                                        <span></span>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="achievements-empty">Keine Achievements vorhanden.</p>
            {% endif %}
            {% if is_owner %}
            <div class="achievements-actions">
                <button type="button" class="btn small primary" id="btn-add-achievement">Achievement hinzufügen</button>
            </div>
            {% endif %}

            <div id="add-achievement-overlay" class="modal-overlay" style="display:none;">
              <div class="modal" role="dialog" aria-modal="true" aria-labelledby="add-achievement-title">
                <h3 id="add-achievement-title">Neues Achievement</h3>
                <form id="add-achievement-form">
                  <div class="form-row">
                    <label for="ach-title">Titel</label>
                    <input id="ach-title" name="titel" type="text" placeholder="z. B. First Blood" required>
                  </div>
                  <div class="form-row">
                    <label for="ach-desc">Beschreibung</label>
                    <textarea id="ach-desc" name="beschreibung" rows="3" placeholder="Kurze Beschreibung..."></textarea>
                  </div>
                  <div class="form-row">
                    <label for="ach-count">Anzahl</label>
                    <input id="ach-count" name="anzahl" type="number" min="1" value="1" required>
                  </div>
                  {% if csrf_token %}
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  {% endif %}
                  <input type="hidden" name="deckname" value="{{ deckname }}">
                  <div class="modal-actions">
                    <button type="button" class="btn" id="btn-cancel-add">Abbrechen</button>
                    <button type="submit" class="btn primary">Speichern</button>
                  </div>
                </form>
              </div>
            </div>


        </div>

    </section>

    {% if show_private_avgs %}
    <section class="deck-participant-averages" aria-label="Participant Averages" style="width:100%; margin-top:12px;">
      <div class="deck-header">
        <div class="deck-header-text">
          <div class="deck-stats-summary">
            <h3 style="margin-top:0;">Participant Averages</h3>
            <div class="participant-avg-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px 16px; align-items:start;">
              <div><strong>Mulligans:</strong> {{ participant_avgs.mulligans }}</div>
              <div><strong>Landdrops:</strong> {{ participant_avgs.landdrops }}</div>
              <div><strong>Enough Mana:</strong> {{ participant_avgs.enough_mana }}</div>
              <div><strong>Enough Gas:</strong> {{ participant_avgs.enough_gas }}</div>
              <div><strong>Deck Plan:</strong> {{ participant_avgs.deckplan }}</div>
              <div><strong>Unanswered Threats:</strong> {{ participant_avgs.unanswered_threats }}</div>
              <div><strong>Fun Moments:</strong> {{ participant_avgs.fun_moments }}</div>
              <div><strong>Lands:</strong> {{ participant_avgs.lands }}</div>
            </div>
          </div>
        </div>
      </div>
    </section>
    {% endif %}

    {% if show_private_comments and private_comments %}
    <aside
      class="deck-comments-box"
      aria-label="Recent Comments"
      style="
        position: fixed;
        top: 120px;
        right: 24px;
        width: 320px;
        max-height: calc(100vh - 160px);
        overflow: auto;
        z-index: 10;
      "
    >
      <!-- Use the same classes as the other stat boxes to inherit background and shadow -->
      <div class="deck-header">
        <div class="deck-header-text">
          <div class="deck-stats-summary">
            <h3 style="margin: 0 0 8px 0;">Recent Comments</h3>
            <div style="display:flex; flex-direction:column; gap:10px;">
              {% for c in private_comments %}
                <div style="border-top: 1px solid rgba(0,0,0,.06); padding-top:8px;">
                  <div style="font-size: 12px; opacity: .7;">{{ c.date }} (Game #{{ c.game_id }})</div>
                  <div style="white-space: pre-wrap;">{{ c.text }}</div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </aside>
    {% endif %}


    <section class="deck-games">
        <h2>Gespielte Spiele</h2>
        <table class="deck-games-table">
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Gegner</th>
                    <th>Sieger</th>
                    <th>Turns</th>
                    <th>Final Blow</th>
                </tr>
            </thead>
            <tbody>
            {% for game in games %}
                <tr>
                    <td>{{ game.Datum }}</td>
                    <td>
                        <div class="opponent-row">
                            {% for opponent in game.Gegner %}
                                <a href="{{ url_for('decks.deck_show', deckname=opponent.deck_name) }}" class="opponent-card" title="Zum Deck: {{ opponent.deck_name }}">
                                    <img src="{{ opponent.commander_image }}" alt="Commander" class="opponent-commander-img">
                                    <div class="opponent-info">
                                        <strong>{{ opponent.player_name }}</strong><br>
                                        <span>{{ opponent.deck_name }}</span>
                                    </div>
                                </a>
                            {% endfor %}
                        </div>
                    </td>
                    <td>{{ game.Winner }}</td>
                    <td>{{ game.Turns}}</td>
                    <td>{{ game.Final_Blow }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </section>
</main>

<script>
// Toggle between Stats (default) and Achievements without altering layout
(function() {
  const btnStats = document.getElementById('btn-mode-stats');
  const btnAch = document.getElementById('btn-mode-achievements');
  const statsText = document.querySelector('.deck-header-text');
  const statsBreakdown = document.querySelector('.deck-stats-breakdown');
  const achBlock = document.getElementById('deck-header-achievements');

  function showStats() {
    statsText.style.display = 'flex';
    statsBreakdown.style.display = 'flex';
    achBlock.style.display = 'none';
    btnStats.classList.add('primary');
    btnAch.classList.remove('primary');
  }

  function showAchievements() {
    statsText.style.display = 'none';
    statsBreakdown.style.display = 'none';
    achBlock.style.display = 'block';
    btnAch.classList.add('primary');
    btnStats.classList.remove('primary');
  }

  btnStats?.addEventListener('click', showStats);
  btnAch?.addEventListener('click', showAchievements);

  // Modal open/close
  const addBtn = document.getElementById('btn-add-achievement');
  const overlay = document.getElementById('add-achievement-overlay');
  const cancelAdd = document.getElementById('btn-cancel-add');
  const addForm = document.getElementById('add-achievement-form');

  function openAddModal() {
    overlay.style.display = 'flex';
    setTimeout(() => document.getElementById('ach-title')?.focus(), 0);
  }
  function closeAddModal() {
    overlay.style.display = 'none';
    addForm?.reset();
  }

  addBtn?.addEventListener('click', openAddModal);
  cancelAdd?.addEventListener('click', closeAddModal);
  overlay?.addEventListener('click', (e) => {
    if (e.target === overlay) closeAddModal();
  });

  // Create card DOM helper
  function createAchievementCard(a) {
    const card = document.createElement('div');
    card.className = 'achievement-card';
    card.setAttribute('data-achievement-id', a.id);
    const checks = Array.from({length: a.anzahl || 0}, (_, i) => `
      <label class="check" title="${i < (a.achieved||0) ? 'erreicht' : 'offen'}">
        <input type="checkbox" class="achievement-check" ${i < (a.achieved||0) ? 'checked' : ''}>
        <span></span>
      </label>
    `).join('');
    card.innerHTML = `
      <div class="achievement-header" style="display:flex; align-items:center; justify-content:space-between;">
        <h4 class="achievement-title" style="margin:0;"></h4>
        <button type="button" class="btn small btn-ach-delete" title="Achievement löschen" aria-label="Achievement löschen">✕</button>
      </div>
      <p class="achievement-desc"></p>
      <div class="achievement-checks">${checks}</div>
    `;
    card.querySelector('.achievement-title').textContent = a.titel || '';
    card.querySelector('.achievement-desc').textContent = a.beschreibung || '';
    return card;
  }

  // Attach checkbox listeners for save (already present change handler)
  function attachCardListeners(card) {
    const initial = card.querySelectorAll('input.achievement-check:checked').length;
    card.setAttribute('data-prev-count', String(initial));
    card.addEventListener('change', (e) => {
      if (e.target && e.target.matches('input.achievement-check')) {
        onChecksChanged(card);
      }
    });
    // Delete button
    const delBtn = card.querySelector('.btn-ach-delete');
    delBtn?.addEventListener('click', () => onDeleteAchievement(card));
  }

  // CSRF token
  const csrfMeta = document.querySelector('meta[name="csrf-token"]');
  const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;

  // Handle Save in the modal: POST to server, then append card to grid
  addForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    const titel = addForm.titel.value.trim();
    if (!titel) {
      addForm.titel.focus();
      return;
    }
    const formData = new FormData(addForm);
    const body = new URLSearchParams(Array.from(formData.entries()));

    fetch(`{{ url_for('decks.add_achievement') }}`, {
      method: 'POST',
      body,
      credentials: 'same-origin'
    }).then(async (r) => {
      const data = await r.json().catch(() => null);
      if (!r.ok || !data || !data.ok) {
        const msg = (data && data.message) || 'Speichern fehlgeschlagen';
        throw new Error(msg);
      }
      let grid = document.getElementById('achievements-grid')
              || document.querySelector('#deck-header-achievements .achievements-grid');
      if (!grid) {
        grid = document.createElement('div');
        grid.className = 'achievements-grid';
        grid.id = 'achievements-grid';
        const actions = document.querySelector('.achievements-actions');
        actions?.parentNode?.insertBefore(grid, actions);
        const empty = document.querySelector('.achievements-empty');
        empty?.remove();
      }
      const card = createAchievementCard(data.achievement);
      grid.appendChild(card);
      attachCardListeners(card);
      closeAddModal();
      const btnAch = document.getElementById('btn-mode-achievements');
      btnAch?.click();
    }).catch((err) => {
      alert(err.message || 'Fehler beim Speichern.');
    });
  });

  // Handle checkbox changes: compute desired count and send to server
  function onChecksChanged(cardEl) {
    const achId = cardEl.getAttribute('data-achievement-id');
    const checks = cardEl.querySelectorAll('input.achievement-check');
    const desired = Array.from(checks).filter(c => c.checked).length;

    fetch(`{{ url_for('decks.set_achievement_progress', achievement_id=0) }}`.replace('0', achId), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(csrfToken ? {'X-CSRFToken': csrfToken, 'X-CSRF-Token': csrfToken} : {})
      },
      body: JSON.stringify({achieved: desired}),
      credentials: 'same-origin'
    }).then(async (r) => {
      const data = await r.json().catch(() => ({}));
      if (!r.ok || !data.ok) {
        throw new Error(data.message || 'Update failed');
      }
      const accepted = data.achieved ?? desired;
      checks.forEach((c, idx) => { c.checked = idx < accepted; });
    }).catch((err) => {
      const previous = cardEl.getAttribute('data-prev-count');
      const prevCount = previous ? parseInt(previous, 10) : 0;
      checks.forEach((c, idx) => { c.checked = idx < prevCount; });
      console.warn('Achievement update failed:', err);
    }).finally(() => {
      const current = Array.from(checks).filter(c => c.checked).length;
      cardEl.setAttribute('data-prev-count', String(current));
    });
  }

  // Delete achievement
  function onDeleteAchievement(cardEl) {
    const achId = cardEl.getAttribute('data-achievement-id');
    if (!achId) return;
    if (!confirm('Achievement wirklich löschen?')) return;

    fetch(`{{ url_for('decks.delete_achievement', achievement_id=0) }}`.replace('0', achId), {
      method: 'POST',
      headers: {
        ...(csrfToken ? {'X-CSRFToken': csrfToken, 'X-CSRF-Token': csrfToken} : {})
      },
      credentials: 'same-origin'
    }).then(async (r) => {
      const data = await r.json().catch(() => null);
      if (!r.ok || !data || !data.ok) {
        const msg = (data && data.message) || 'Löschen fehlgeschlagen';
        throw new Error(msg);
      }
      cardEl.remove();
      // If grid becomes empty, show placeholder
      const grid = document.getElementById('achievements-grid');
      if (grid && grid.children.length === 0) {
        const p = document.createElement('p');
        p.className = 'achievements-empty';
        p.textContent = 'Keine Achievements vorhanden.';
        grid.parentNode.insertBefore(p, grid.nextSibling);
      }
    }).catch((err) => {
      alert(err.message || 'Fehler beim Löschen.');
    });
  }

  // Initialize prev-count and attach listeners
  document.querySelectorAll('.achievement-card').forEach(card => {
    const initial = card.querySelectorAll('input.achievement-check:checked').length;
    card.setAttribute('data-prev-count', String(initial));
    card.addEventListener('change', (e) => {
      if (e.target && e.target.matches('input.achievement-check')) {
        onChecksChanged(card);
      }
    });
    const delBtn = card.querySelector('.btn-ach-delete');
    delBtn?.addEventListener('click', () => onDeleteAchievement(card));
  });
})();
</script>


{% endblock %}